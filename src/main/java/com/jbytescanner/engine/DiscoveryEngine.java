package com.jbytescanner.engine;

import com.jbytescanner.core.SootManager;
import com.jbytescanner.model.ApiRoute;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.StandardOpenOption;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

public class DiscoveryEngine {
    private static final Logger logger = LoggerFactory.getLogger(DiscoveryEngine.class);
    private final List<String> jarPaths;
    private final File workspaceDir;

    public DiscoveryEngine(List<String> jarPaths, File workspaceDir) {
        this.jarPaths = jarPaths;
        this.workspaceDir = workspaceDir;
    }

    public void run() {
        logger.info("Starting Discovery Engine...");
        
        // 1. Init Soot
        SootManager.initSoot(jarPaths);
        
        // 2. Extract Routes
        RouteExtractor extractor = new RouteExtractor();
        List<ApiRoute> routes = extractor.extract();
        
        logger.info("Found {} API Routes.", routes.size());
        
        // 3. Write Output
        writeApiTxt(routes);
    }

    private void writeApiTxt(List<ApiRoute> routes) {
        // Output file is always "api.txt" inside the project's .jbytescanner folder
        File apiFile = new File(workspaceDir, "api.txt");
        
        List<String> lines = new ArrayList<>();
        // Add Header for audit trail
        String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));
        lines.add(String.format("### Generated by JByteScanner at %s | Jars: %d ###", timestamp, jarPaths.size()));
        
        lines.addAll(routes.stream()
                .map(ApiRoute::toString)
                .collect(Collectors.toList()));
        
        try {
            // We overwrite now, because each project has its own folder
            Files.write(apiFile.toPath(), lines);
            logger.info("API Dictionary written to: {}", apiFile.getAbsolutePath());
        } catch (IOException e) {
            logger.error("Failed to write api file", e);
        }
    }
}
